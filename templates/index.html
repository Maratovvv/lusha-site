<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lusha ‚Äî Voice Assistant</title>
<link rel="stylesheet" href="/static/style.css" />
<link rel="icon" href="/static/logo.png" />
<style>
  /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –∫–∞–Ω–≤–∞—Å–∞ */
  #effect-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  #effect-canvas.active {
    opacity: 1;
  }
</style>
</head>
<body>
<audio id="click-sound" src="/static/click.mp3" preload="auto"></audio>

<div class="container">
    <div class="games-buttons" style="margin-top: 15px;">
        <p>–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è:</p>
        <button onclick="sendGameCommand('–∑–∞–≥–∞–¥–∫–∞')">–ó–∞–≥–∞–¥–∫–∞</button>
        <button onclick="sendGameCommand('–≤–∏–∫—Ç–æ—Ä–∏–Ω–∞')">–í–∏–∫—Ç–æ—Ä–∏–Ω–∞</button>
        <button onclick="sendGameCommand('—à—É—Ç–∫–∞')">–®—É—Ç–∫–∞</button>
        <button onclick="sendGameCommand('—Ñ–∞–∫—Ç')">–§–∞–∫—Ç</button>
      </div>      
  <img src="/static/logo1.png" alt="Lusha logo" class="logo" />
  <h1>Lusha</h1>
  <p class="slogan">–í—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏.</p>
  <p class="subtitle">–¢–≤–æ–π –≥–æ–ª–æ—Å–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤—Ä–µ–º—è, —à—É—Ç–∫–∏ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ.</p>

  <!-- –ù–æ–≤—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–∞ -->
  <label for="language-select">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / Choose language:</label>
  <select id="language-select" style="margin-bottom:10px;">
    <option value="ru-RU" selected>–†—É—Å—Å–∫–∏–π</option>
    <option value="en-US">English</option>
    <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —è–∑—ã–∫–∏ -->
  </select>

  <div id="chat-box"></div>

  <input type="text" id="inputText" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–∞—Ç–∞ / What's the date today?" />
  <button onclick="sendQuestion()">–°–ø—Ä–æ—Å–∏—Ç—å</button>
  <button onclick="startListening()">üé§ –ì–æ–≤–æ—Ä–∏—Ç—å</button>
  <button onclick="clearChat()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>

  <div class="examples">
    <p style="margin-bottom: 5px;">–ü–æ–ø—Ä–æ–±—É–π:</p>
    <button onclick="quickAsk('—à—É—Ç–∫–∞')">–®—É—Ç–∫–∞</button>
    <button onclick="quickAsk('–¥–∞—Ç–∞')">–î–∞—Ç–∞</button>
    <button onclick="quickAsk('–≤—Ä–µ–º—è')">–í—Ä–µ–º—è</button>
    <button onclick="quickAsk('—Å—Ç–æ–ø')">–°—Ç–æ–ø</button>
  </div>
</div>

<canvas id="effect-canvas"></canvas>

<script>
  document.getElementById('inputText').focus();
  document.getElementById('inputText').addEventListener('keydown', function (e) {
      if (e.key === 'Enter') sendQuestion();
  });

  const canvas = document.getElementById('effect-canvas');
  const ctx = canvas.getContext('2d');

  function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function createParticles(type) {
      const particlesCount = 100;
      const particles = [];

      for (let i = 0; i < particlesCount; i++) {
          particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height - canvas.height,
              size: Math.random() * 8 + 5,
              speedY: Math.random() * 3 + 2,
              speedX: (Math.random() - 0.5) * 2,
              rotation: Math.random() * 360,
              rotationSpeed: (Math.random() - 0.5) * 10,
              type: type,
              color: `hsl(${Math.random() * 360}, 100%, 70%)`
          });
      }
      return particles;
  }

  function drawParticle(p) {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rotation * Math.PI / 180);

      if (p.type === 'confetti') {
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 4, p.size, p.size / 2);
      } else if (p.type === 'heart') {
          ctx.fillStyle = 'red';
          const s = p.size / 2;
          ctx.beginPath();
          ctx.moveTo(0, s);
          ctx.bezierCurveTo(0, s - s * 1.2, -s, s - s * 1.2, -s, s / 3);
          ctx.bezierCurveTo(-s, 0, 0, 0, 0, s / 3);
          ctx.bezierCurveTo(0, 0, s, 0, s, s / 3);
          ctx.bezierCurveTo(s, s - s * 1.2, 0, s - s * 1.2, 0, s);
          ctx.closePath();
          ctx.fill();
      }

      ctx.restore();
  }

  function animateParticles(particles) {
      let animationId;
      canvas.classList.add('active');

      function animate() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          particles.forEach(p => {
              p.y += p.speedY;
              p.x += p.speedX;
              p.rotation += p.rotationSpeed;

              if (p.y > canvas.height) {
                  p.y = -p.size;
                  p.x = Math.random() * canvas.width;
              }
              drawParticle(p);
          });

          animationId = requestAnimationFrame(animate);
      }

      animate();

      setTimeout(() => {
          cancelAnimationFrame(animationId);
          canvas.classList.remove('active');
          setTimeout(() => ctx.clearRect(0, 0, canvas.width, canvas.height), 500);
      }, 5000);
  }

  function launchEffect(type) {
      const particles = createParticles(type);
      animateParticles(particles);
  }

  function addMessage(sender, text) {
      const box = document.getElementById('chat-box');
      const wrapper = document.createElement('div');
      wrapper.className = 'message-wrapper ' + sender;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.style.backgroundImage =
          sender === 'bot' ? "url('/static/logo1.png')" : "url('/static/user.png')";

      const msg = document.createElement('div');
      msg.className = 'message ' + sender;
      msg.innerText = text;

      wrapper.appendChild(avatar);
      wrapper.appendChild(msg);
      box.appendChild(wrapper);
      box.scrollTop = box.scrollHeight;
  }

  // –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —Å –≤—ã–±–æ—Ä–æ–º —è–∑—ã–∫–∞ –∏ –≥–æ–ª–æ—Å–∞
  const synth = window.speechSynthesis;
  let voices = [];

  function populateVoices() {
    voices = synth.getVoices();
  }
  populateVoices();
  if (synth.onvoiceschanged !== undefined) {
    synth.onvoiceschanged = populateVoices;
  }

  function speak(text, lang) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;

      // –ü–æ–¥–±–∏—Ä–∞–µ–º –≥–æ–ª–æ—Å –ø–æ —è–∑—ã–∫—É
      const voice = voices.find(v => v.lang.startsWith(lang));
      if (voice) {
          utterance.voice = voice;
      }

      synth.speak(utterance);
  }

  function sendQuestion() {
      const inputField = document.getElementById('inputText');
      const input = inputField.value.trim();
      if (!input) return;

      const lang = document.getElementById('language-select').value;

      addMessage('user', input);
      inputField.value = '';

      if (/—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|thank you/i.test(input)) {
          const thankReply = lang.startsWith('en') ? 'You are welcome! Always happy to help üòä' : '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! –í—Å–µ–≥–¥–∞ —Ä–∞–¥–∞ –ø–æ–º–æ—á—å üòä';
          addMessage('bot', thankReply);
          speak(thankReply, lang);
          launchEffect('confetti');
          return;
      }

      if (/–º–æ–ª–æ–¥–µ—Ü|–∫–ª–∞—Å—Å|–æ—Ç–ª–∏—á–Ω–æ|—Ö–æ—Ä–æ—à–æ|–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ|–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ/i.test(input)) {
          const praiseReply = lang.startsWith('en') ? 'Thank you! I am very glad üòä' : '–°–ø–∞—Å–∏–±–æ! –ú–Ω–µ –æ—á–µ–Ω—å –ø—Ä–∏—è—Ç–Ω–æ üòä';
          addMessage('bot', praiseReply);
          speak(praiseReply, lang);
          launchEffect('heart');
          return;
      }

      const typing = document.createElement('div');
      typing.id = 'typing';
      typing.className = 'bot';
      typing.innerText = lang.startsWith('en') ? 'Lusha is typing...' : 'Lusha –ø–µ—á–∞—Ç–∞–µ—Ç...';
      document.getElementById('chat-box').appendChild(typing);

      fetch('/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: input, lang: lang }),
      })
          .then((res) => res.json())
          .then((data) => {
              const typingBox = document.getElementById('typing');
              if (typingBox) typingBox.remove();

              addMessage('bot', data.answer);
              speak(data.answer, lang);
          });
  }

  function quickAsk(text) {
      document.getElementById('inputText').value = text;
      sendQuestion();
  }

  function startListening() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      const lang = document.getElementById('language-select').value;
      recognition.lang = lang;
      recognition.start();
      recognition.onresult = function (event) {
          const text = event.results[0][0].transcript;
          document.getElementById('inputText').value = text;
          sendQuestion();
      };
  }

  function clearChat() {
      document.getElementById('chat-box').innerHTML = '';
      document.getElementById('inputText').focus();
  }

  document.addEventListener('DOMContentLoaded', () => {
      const clickSound = document.getElementById('click-sound');
      document.querySelectorAll('button').forEach((btn) => {
          btn.addEventListener('click', () => {
              clickSound.currentTime = 0;
              clickSound.play();
          });
      });
  });

  window.addEventListener('load', () => {
      const greeting = '–ü—Ä–∏–≤–µ—Ç! –Ø –õ—É—à–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?';
      addMessage('bot', greeting);
      speak(greeting, 'ru-RU');
  });
</script>
</body>
</html>
